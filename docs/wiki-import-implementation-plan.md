# Wiki URL自動インポート機能 実装計画書

## 📋 概要

城プロREのWiki（https://scre.swiki.jp/）からキャラクター情報を自動取得し、キャラクター登録を簡略化する機能を実装する。

**目標**: WikiのURLを貼り付けるだけで、キャラクター情報をフォームに自動入力する

---

## 🎯 実装フェーズ

### Phase 1: 基本情報の自動入力 ⭐ **優先**

#### 1.1 UI追加
- キャラクター管理タブの上部に「Wiki URLからインポート」セクションを追加
- 構成要素:
  ```
  [Wiki URLからインポート]
  ┌─────────────────────────────────────┐
  │ https://scre.swiki.jp/index.php?... │ [URLから取得]
  └─────────────────────────────────────┘
  ステータス表示: 取得中... / 成功 / エラー
  ```

#### 1.2 データ取得
- **CORS対策**: プロキシサービスを使用
  - 候補: `https://api.allorigins.win/raw?url=` または `https://corsproxy.io/?`
- DOMParserでHTMLをパース
- エラーハンドリング（ネットワークエラー、無効なURL）

#### 1.3 抽出する情報

| 項目 | 抽出元 | マッピング |
|------|--------|------------|
| **名前** | ページタイトル | そのまま使用 |
| **期間** | 名前の接頭辞 `［絢爛］`, `［響乱］` など | 抽出して別フィールドに |
| **武器種** | 基本情報テーブル「武器属性」 | マッピングテーブル参照 |
| **遠近** | 武器種から判定 | 武器種マッピングテーブル |
| **物術** | 武器種から判定 | 武器種マッピングテーブル |
| **配置** | 武器種から判定 | 武器種マッピングテーブル |
| **属性** | 基本情報テーブル「城属性」 | `平山水` → `["平","山","水"]` |

---

### Phase 2: 特技・計略のテキスト表示 🔮

#### 2.1 説明文抽出
- Wikiから以下のテキストを取得:
  - 編成特技（存在する場合）
  - 特技（無印、改壱）
  - 計略（無印、改壱）

#### 2.2 UI表示
- フォームの各バフ入力エリアに「Wikiテキスト参照」ボタンを追加
- モーダルまたは展開エリアで元のテキストを表示
- ユーザーが見ながら手動で入力できるようにする

---

### Phase 3: バフの半自動解析（将来的） 🚀

#### 3.1 パターンマッチング
正規表現で以下のパターンを検出:

| パターン | マッチ例 | 変換結果 |
|----------|----------|----------|
| `攻撃(\d+)%上昇` | 攻撃40%上昇 | `攻撃割合/+%/40` |
| `防御(\d+)%上昇` | 防御30%上昇 | `防御割合/+%/30` |
| `防御を無視` | 防御を無視 | `防御無視` |
| `ダメージ(\d+\.?\d*)倍` | ダメージ1.5倍 | `与ダメ/×/1.5` |
| `射程(\d+)上昇` | 射程50上昇 | `射程固定/+/50` |

#### 3.2 対象の判定
- `自身` / `味方全員` / `味方射程内` などのキーワードを検出
- `味方〇〇` → 特定武器種への限定バフ判定

#### 3.3 条件の抽出
- `敵の防御50%以下` → 条件フィールドに追加
- `近接単体のみ` → 条件フィールドに追加

---

## 🛠 技術詳細

### 武器種マッピングテーブル

調査が必要だが、以下のような構造を想定:

```javascript
const weaponMapping = {
  "弓": { range: "遠", type: "物", placement: "遠" },
  "鉄砲": { range: "遠", type: "物", placement: "遠" },
  "石弓": { range: "遠", type: "物", placement: "遠" },
  "歌舞": { range: "遠", type: "術", placement: "遠" },
  "本": { range: "遠", type: "術", placement: "遠" },
  "軍船": { range: "遠", type: "物", placement: "遠" },
  "槍": { range: "近", type: "物", placement: "近" },
  "刀": { range: "近", type: "物", placement: "近" },
  "盾": { range: "近", type: "物", placement: "近" },
  "大砲": { range: "遠", type: "物", placement: "遠近" },
  // ... 他の武器種
};
```

### Wiki HTML構造（調査結果）

#### 共通パターン
```html
<!-- 基本情報テーブル -->
<table>
  <tr><th>図鑑No.</th><td>950</td></tr>
  <tr><th>レア</th><td>7</td></tr>
  <tr><th>城属性</th><td>水 or 平山水</td></tr>
  <tr><th>武器属性</th><td>本</td></tr>
</table>

<!-- 特技・計略 -->
<h3>特技</h3>
<div>テキスト説明...</div>

<h3>計略</h3>
<div>テキスト説明...</div>
```

#### バリエーション
- **絢爛/響乱版**: 名前に `［絢爛］` などの接頭辞
- **改築版**: 「無印」「改壱」「改弐」でセクション分割
- **複数計略**: 切り替え可能な場合あり

---

## 🚧 技術的課題と対策

| 課題 | 対策 |
|------|------|
| **CORS制約** | CORSプロキシ（allorigins, corsproxy）を使用 |
| **HTML構造の不統一** | 複数パターンに対応したフォールバック処理 |
| **特技テキストの複雑さ** | Phase 2では表示のみ、Phase 3で段階的に解析精度を向上 |
| **武器種の網羅性** | サンプルデータから武器種を収集してマッピングテーブル作成 |
| **ネットワークエラー** | タイムアウト設定、リトライ機能、エラーメッセージ表示 |

---

## 📝 実装順序

```
1. ✅ Wiki構造調査（完了）
   ├─ ダノター城（絢爛版）
   ├─ 舞鶴（軍港）
   └─ 室町第（響乱版）

2. 🔄 武器種マッピングテーブル作成
   └─ sample-characters.jsonから武器種を収集

3. 📦 データ抽出関数実装
   ├─ fetchWikiPage(url)
   ├─ parseCharacterInfo(html)
   └─ extractSkillTexts(html)

4. 🎨 UI実装
   ├─ URL入力フィールド追加
   ├─ 取得ボタンとローディング表示
   └─ エラーメッセージ表示

5. 🔗 統合処理
   └─ 取得データをフォームに自動入力

6. ✅ テスト
   ├─ ［絢爛］ダノター城
   ├─ 軍港 舞鶴
   └─ ［響乱］室町第
```

---

## 🎯 成功基準

### Phase 1（必須）
- [ ] WikiのURLを入力して「取得」ボタンをクリック
- [ ] 名前、武器種、属性、遠近、物術、配置が自動入力される
- [ ] エラー時に適切なメッセージが表示される
- [ ] 提供された3つのURLで正常動作する

### Phase 2（推奨）
- [ ] 特技・計略のテキストが参照可能
- [ ] ユーザーが見ながら手動入力できる

### Phase 3（オプション）
- [ ] 単純なバフパターンが自動検出される
- [ ] 検出されたバフがバフリストに追加される
- [ ] ユーザーが確認・修正できる

---

## 📅 実装スケジュール

| フェーズ | 優先度 | 推定工数 |
|---------|--------|----------|
| Phase 1 | 🔴 高 | 2-3時間 |
| Phase 2 | 🟡 中 | 1時間 |
| Phase 3 | 🟢 低 | 3-4時間（精度向上のため継続的） |

---

## 💡 将来的な拡張案

1. **お気に入りURL登録**: よく使うキャラページをブックマーク
2. **一括インポート**: 複数URLを連続で処理
3. **画像取得**: キャラクターアイコンをWikiから取得
4. **ステータス値取得**: 攻撃力・防御力などの数値も取得
5. **バフ解析の学習機能**: ユーザーの修正をフィードバックして精度向上

---

## 🔍 参考情報

### テストURL
1. https://scre.swiki.jp/index.php?［絢爛］ダノター城
2. https://scre.swiki.jp/index.php?軍港%20舞鶴
3. https://scre.swiki.jp/index.php?［響乱］室町第

### 既存のデータ構造
```javascript
// characters配列の要素
{
  id: 1234567890,
  name: "ダノター城",
  period: "絢爛",
  weapon: "弓",
  weaponRange: "遠",
  weaponType: "物",
  placement: "遠",
  attributes: ["平","山","水"],
  skills: ["味方射程内/攻撃割合/+%/40"],
  formationSkills: [],
  strategies: []
}
```
