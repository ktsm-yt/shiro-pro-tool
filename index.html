<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸãƒ—ãƒ­ç·¨æˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 15px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç† */
        .character-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .buff-input-area {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }

        .buffs-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .buff-tag {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .buff-tag button {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            cursor: pointer;
            font-size: 10px;
            padding: 0;
        }

        .buff-tag button:hover {
            background: rgba(255,255,255,0.5);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .button-group label {
            font-size: 12px;
            font-weight: bold;
            width: 100%;
            margin-bottom: 5px;
        }

        .select-button {
            padding: 6px 12px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .select-button:hover {
            border-color: #667eea;
        }

        .select-button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .select-button.compact {
            padding: 4px 10px;
            font-size: 12px;
            min-width: 40px;
        }

        /* ãƒœã‚¿ãƒ³ã®ç¨®åˆ¥ã”ã¨ã®è‰²åˆ†ã‘ */
        /* é è¿‘ */
        .select-button[data-value="é "]:not(.active) {
            background: #e3f2fd;
            border-color: #64b5f6;
            color: #1976d2;
        }
        .select-button[data-value="é "].active {
            background: #2196f3;
            border-color: #2196f3;
        }
        .select-button[data-value="è¿‘"]:not(.active) {
            background: #ffebee;
            border-color: #e57373;
            color: #c62828;
        }
        .select-button[data-value="è¿‘"].active {
            background: #f44336;
            border-color: #f44336;
        }

        /* ç‰©è¡“ */
        .select-button[data-value="ç‰©"]:not(.active) {
            background: #fff3e0;
            border-color: #ffb74d;
            color: #e65100;
        }
        .select-button[data-value="ç‰©"].active {
            background: #ff9800;
            border-color: #ff9800;
        }
        .select-button[data-value="è¡“"]:not(.active) {
            background: #f3e5f5;
            border-color: #ba68c8;
            color: #6a1b9a;
        }
        .select-button[data-value="è¡“"].active {
            background: #9c27b0;
            border-color: #9c27b0;
        }

        /* å±æ€§ */
        .select-button[data-value="æ°´"]:not(.active) {
            background: #e1f5fe;
            border-color: #4fc3f7;
            color: #0277bd;
        }
        .select-button[data-value="æ°´"].active {
            background: #03a9f4;
            border-color: #03a9f4;
        }
        .select-button[data-value="å¹³"]:not(.active) {
            background: #e8f5e9;
            border-color: #81c784;
            color: #2e7d32;
        }
        .select-button[data-value="å¹³"].active {
            background: #4caf50;
            border-color: #4caf50;
        }
        .select-button[data-value="å±±"]:not(.active) {
            background: #efebe9;
            border-color: #a1887f;
            color: #4e342e;
        }
        .select-button[data-value="å±±"].active {
            background: #795548;
            border-color: #795548;
        }
        .select-button[data-value="å¹³å±±"]:not(.active) {
            background: #f9fbe7;
            border-color: #aed581;
            color: #558b2f;
        }
        .select-button[data-value="å¹³å±±"].active {
            background: #8bc34a;
            border-color: #8bc34a;
        }

        /* é…ç½®ï¼ˆé è¿‘ï¼‰ */
        .select-button[data-group="placement"][data-value="é è¿‘"]:not(.active) {
            background: #f3e5f5;
            border-color: #ba68c8;
            color: #6a1b9a;
        }
        .select-button[data-group="placement"][data-value="é è¿‘"].active {
            background: #9c27b0;
            border-color: #9c27b0;
        }

        /* ãƒãƒ•ç¨®ã®è‰²åˆ†ã‘ï¼ˆã‚°ãƒ©ãƒ•ã®è‰²ã¨çµ±ä¸€ï¼‰ */
        /* æ”»æ’ƒç³» (#fd79a8 ãƒ”ãƒ³ã‚¯) */
        .select-button[data-value="æ”»æ’ƒå›ºå®š"]:not(.active),
        .select-button[data-value="æ”»æ’ƒå‰²åˆ"]:not(.active),
        .select-button[data-value="ä¸ãƒ€ãƒ¡"]:not(.active),
        .select-button[data-value="ä¸ãˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸"]:not(.active),
        .select-button[data-value="è¢«ãƒ€ãƒ¡"]:not(.active),
        .select-button[data-value="é˜²å¾¡ãƒ‡ãƒãƒ•å›ºå®š"]:not(.active),
        .select-button[data-value="é˜²å¾¡ãƒ‡ãƒãƒ•å‰²åˆ"]:not(.active) {
            background: #ffe0ee;
            border-color: #fd79a8;
            color: #c2185b;
        }
        .select-button[data-value="æ”»æ’ƒå›ºå®š"].active,
        .select-button[data-value="æ”»æ’ƒå‰²åˆ"].active,
        .select-button[data-value="ä¸ãƒ€ãƒ¡"].active,
        .select-button[data-value="ä¸ãˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸"].active,
        .select-button[data-value="è¢«ãƒ€ãƒ¡"].active,
        .select-button[data-value="é˜²å¾¡ãƒ‡ãƒãƒ•å›ºå®š"].active,
        .select-button[data-value="é˜²å¾¡ãƒ‡ãƒãƒ•å‰²åˆ"].active {
            background: #fd79a8;
            border-color: #fd79a8;
        }

        /* é˜²å¾¡ç³» (#95a5a6 ã‚°ãƒ¬ãƒ¼) */
        .select-button[data-value="é˜²å¾¡"]:not(.active),
        .select-button[data-value="æ”»æ’ƒãƒ‡ãƒãƒ•å›ºå®š"]:not(.active),
        .select-button[data-value="æ”»æ’ƒãƒ‡ãƒãƒ•å‰²åˆ"]:not(.active) {
            background: #eceff1;
            border-color: #95a5a6;
            color: #455a64;
        }
        .select-button[data-value="é˜²å¾¡"].active,
        .select-button[data-value="æ”»æ’ƒãƒ‡ãƒãƒ•å›ºå®š"].active,
        .select-button[data-value="æ”»æ’ƒãƒ‡ãƒãƒ•å‰²åˆ"].active {
            background: #95a5a6;
            border-color: #95a5a6;
        }

        /* é€Ÿåº¦ (#43e97b ç·‘) */
        .select-button[data-value="é€Ÿåº¦"]:not(.active),
        .select-button[data-value="éš™"]:not(.active) {
            background: #e0f7ed;
            border-color: #43e97b;
            color: #1b5e20;
        }
        .select-button[data-value="é€Ÿåº¦"].active,
        .select-button[data-value="éš™"].active {
            background: #43e97b;
            border-color: #43e97b;
        }

        /* å°„ç¨‹ (#e74c3c èµ¤) */
        .select-button[data-value="å°„ç¨‹å›ºå®š"]:not(.active),
        .select-button[data-value="å°„ç¨‹å‰²åˆ"]:not(.active) {
            background: #ffebee;
            border-color: #e74c3c;
            color: #b71c1c;
        }
        .select-button[data-value="å°„ç¨‹å›ºå®š"].active,
        .select-button[data-value="å°„ç¨‹å‰²åˆ"].active {
            background: #e74c3c;
            border-color: #e74c3c;
        }

        /* ç§»å‹•é€Ÿåº¦ (#f39c12 ã‚ªãƒ¬ãƒ³ã‚¸) */
        .select-button[data-value="ç§»å‹•å¤‰æ›´"]:not(.active),
        .select-button[data-value="ç§»å‹•ä½ä¸‹"]:not(.active),
        .select-button[data-value="ç§»å‹•åœæ­¢"]:not(.active),
        .select-button[data-value="ç§»å‹•å¾Œé€€"]:not(.active) {
            background: #fff3e0;
            border-color: #f39c12;
            color: #e65100;
        }
        .select-button[data-value="ç§»å‹•å¤‰æ›´"].active,
        .select-button[data-value="ç§»å‹•ä½ä¸‹"].active,
        .select-button[data-value="ç§»å‹•åœæ­¢"].active,
        .select-button[data-value="ç§»å‹•å¾Œé€€"].active {
            background: #f39c12;
            border-color: #f39c12;
        }

        /* æ°—ç®¡ç† (#4facfe é’) */
        .select-button[data-value="è‡ªç„¶æ°—"]:not(.active),
        .select-button[data-value="æ°—(ç‰›)"]:not(.active),
        .select-button[data-value="æ°—(ãƒãƒ“)"]:not(.active),
        .select-button[data-value="å¾ã€…æ°—"]:not(.active),
        .select-button[data-value="æ°—è»½æ¸›"]:not(.active),
        .select-button[data-value="æ°—"]:not(.active),
        .select-button[data-value="è€ä¹…"]:not(.active) {
            background: #e1f5fe;
            border-color: #4facfe;
            color: #01579b;
        }
        .select-button[data-value="è‡ªç„¶æ°—"].active,
        .select-button[data-value="æ°—(ç‰›)"].active,
        .select-button[data-value="æ°—(ãƒãƒ“)"].active,
        .select-button[data-value="å¾ã€…æ°—"].active,
        .select-button[data-value="æ°—è»½æ¸›"].active,
        .select-button[data-value="æ°—"].active,
        .select-button[data-value="è€ä¹…"].active {
            background: #4facfe;
            border-color: #4facfe;
        }

        .btn {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .character-grid.compact-grid {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }

        .character-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .compact-grid .character-card {
            padding: 10px;
            border-radius: 8px;
        }

        .character-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            transform: translateY(-3px);
        }

        .character-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .compact-grid .character-card h3 {
            font-size: 14px;
            margin-bottom: 0;
            text-align: center;
        }

        .character-card .meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .character-card .buffs {
            font-size: 13px;
            color: #333;
            margin-top: 10px;
        }

        .delete-btn {
            background: #ff4757;
            padding: 5px 15px;
            font-size: 12px;
            margin-top: 10px;
        }

        .delete-btn:hover {
            background: #ee5a6f;
        }

        /* ç·¨æˆä½œæˆ */
        .formation-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .formation-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .formation-slot {
            background: white;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 12px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.3s;
        }

        .formation-slot.empty {
            color: #999;
            font-size: 12px;
        }

        .formation-slot.filled {
            border: 2px solid #667eea;
            background: #f0f3ff;
            cursor: pointer;
        }

        .formation-slot.filled:hover {
            background: #e5e9ff;
            transform: scale(1.05);
        }

        .formation-slot h4 {
            color: #667eea;
            margin-bottom: 3px;
            font-size: 13px;
        }

        .formation-slot .meta {
            font-size: 10px;
            color: #666;
            text-align: center;
            line-height: 1.3;
        }

        .character-selection {
            margin-bottom: 30px;
        }

        .character-selection h3 {
            font-size: 16px;
            margin-bottom: 15px;
        }

        .character-card.in-formation {
            opacity: 0.6;
            border-color: #667eea;
            background: #e8ecff;
        }

        .character-card.in-formation:hover {
            border-color: #ff4757;
            opacity: 0.8;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3);
        }

        .formation-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .formation-actions input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }

        .saved-formations {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .saved-formation-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .saved-formation-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .saved-formation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .saved-formation-name {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }

        .saved-formation-actions {
            display: flex;
            gap: 10px;
        }

        .saved-formation-members {
            font-size: 14px;
            color: #666;
        }

        /* æ£’ã‚°ãƒ©ãƒ• */
        .chart-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .bar-chart {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }

        .compact-bars {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            height: 180px;
            padding: 10px;
            background: white;
            border-radius: 10px;
            overflow-x: auto;
        }

        .compact-bar-item {
            min-width: 35px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }

        .compact-bar-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
        }

        .compact-bar-fill {
            width: 100%;
            border-radius: 3px 3px 0 0;
            transition: height 0.5s ease;
            position: relative;
            min-height: 3px;
        }

        .compact-bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
        }

        .compact-bar-label {
            margin-top: 5px;
            font-size: 9px;
            color: #333;
            text-align: center;
            writing-mode: vertical-rl;
            height: 80px;
            overflow: hidden;
        }

        .category-divider {
            width: 2px;
            height: 100%;
            background: #e0e0e0;
            margin: 0 5px;
        }

        /* ç·¨æˆæ¯”è¼ƒ */
        .comparison-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .comparison-chart-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .formation-checkbox {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .formation-checkbox:hover {
            border-color: #667eea;
        }

        .formation-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
        }

        .formation-checkbox-label {
            flex: 1;
        }

        .formation-checkbox-name {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .formation-checkbox-members {
            font-size: 12px;
            color: #666;
        }

        .comparison-bar-group {
            margin-bottom: 30px;
        }

        .comparison-bar-label {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .comparison-bar {
            margin-bottom: 10px;
        }

        .comparison-bar-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .comparison-bar-formation-name {
            font-weight: bold;
        }

        .comparison-bar-score {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ åŸãƒ—ãƒ­ç·¨æˆãƒ„ãƒ¼ãƒ«</h1>

        <div class="tabs">
            <button class="tab active" data-tab="characters">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç†</button>
            <button class="tab" data-tab="formation">ç·¨æˆä½œæˆ</button>
            <button class="tab" data-tab="comparison">ç·¨æˆæ¯”è¼ƒ</button>
        </div>

        <div id="characters" class="tab-content active">
            <h2>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç®¡ç†</h2>

            <div class="character-form">
                <h3 id="formTitle">æ–°è¦ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ </h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>åå‰</label>
                        <input type="text" id="charName" placeholder="ä¾‹ï¼šãƒ‰ãƒ¬ãƒƒãƒ‰ãƒãƒ¼ãƒˆ">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>æœŸé–“ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                        <input type="text" id="charPeriod" placeholder="ä¾‹ï¼šå«ã€æšæ˜Ÿ">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>æ­¦å™¨ç¨®</label>
                        <input type="text" id="charWeapon" placeholder="ä¾‹ï¼šè»èˆ¹">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>é è¿‘</label>
                        <div class="button-group" style="margin-bottom: 0;">
                            <button type="button" class="select-button compact" data-group="weaponRange" data-value="é ">é </button>
                            <button type="button" class="select-button compact" data-group="weaponRange" data-value="è¿‘">è¿‘</button>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>ç‰©è¡“</label>
                        <div class="button-group" style="margin-bottom: 0;">
                            <button type="button" class="select-button compact" data-group="weaponType" data-value="ç‰©">ç‰©</button>
                            <button type="button" class="select-button compact" data-group="weaponType" data-value="è¡“">è¡“</button>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>å±æ€§ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                        <div class="button-group" style="margin-bottom: 0;">
                            <button type="button" class="select-button compact multi-select" data-group="attribute" data-value="æ°´">æ°´</button>
                            <button type="button" class="select-button compact multi-select" data-group="attribute" data-value="å¹³">å¹³</button>
                            <button type="button" class="select-button compact multi-select" data-group="attribute" data-value="å±±">å±±</button>
                            <button type="button" class="select-button compact multi-select" data-group="attribute" data-value="å¹³å±±">å¹³å±±</button>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>é…ç½®</label>
                        <div class="button-group" style="margin-bottom: 0;">
                            <button type="button" class="select-button compact" data-group="placement" data-value="é ">é </button>
                            <button type="button" class="select-button compact" data-group="placement" data-value="è¿‘">è¿‘</button>
                            <button type="button" class="select-button compact" data-group="placement" data-value="é è¿‘">é è¿‘</button>
                        </div>
                    </div>
                </div>

                <!-- ç‰¹æŠ€å…¥åŠ› -->
                <div class="form-group">
                    <label>ç‰¹æŠ€</label>
                    <div class="buff-input-area">
                        <div class="button-group">
                            <label>å¯¾è±¡</label>
                            <button type="button" class="select-button" data-group="skillTarget" data-value="è‡ªèº«">è‡ªèº«</button>
                            <button type="button" class="select-button" data-group="skillTarget" data-value="å‘³æ–¹å°„ç¨‹å†…">å‘³æ–¹å°„ç¨‹å†…</button>
                            <button type="button" class="select-button" data-group="skillTarget" data-value="å‘³æ–¹å…¨å“¡">å‘³æ–¹å…¨å“¡</button>
                        </div>
                        <div class="button-group">
                            <label>ãƒãƒ•ç¨®</label>
                            <button type="button" class="select-button" data-group="skillType" data-value="æ”»æ’ƒå›ºå®š">æ”»æ’ƒå›ºå®š</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="æ”»æ’ƒå‰²åˆ">æ”»æ’ƒå‰²åˆ</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="ä¸ãƒ€ãƒ¡">ä¸ãƒ€ãƒ¡</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="ä¸ãˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸">ä¸ãˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="è¢«ãƒ€ãƒ¡">è¢«ãƒ€ãƒ¡</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="é˜²å¾¡">é˜²å¾¡</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="é˜²å¾¡ãƒ‡ãƒãƒ•å›ºå®š">é˜²å¾¡ãƒ‡ãƒãƒ•å›ºå®š</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="é˜²å¾¡ãƒ‡ãƒãƒ•å‰²åˆ">é˜²å¾¡ãƒ‡ãƒãƒ•å‰²åˆ</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="æ”»æ’ƒãƒ‡ãƒãƒ•å›ºå®š">æ”»æ’ƒãƒ‡ãƒãƒ•å›ºå®š</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="æ”»æ’ƒãƒ‡ãƒãƒ•å‰²åˆ">æ”»æ’ƒãƒ‡ãƒãƒ•å‰²åˆ</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="é€Ÿåº¦">é€Ÿåº¦</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="éš™">éš™</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="å°„ç¨‹å›ºå®š">å°„ç¨‹å›ºå®š</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="å°„ç¨‹å‰²åˆ">å°„ç¨‹å‰²åˆ</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="ç§»å‹•å¤‰æ›´">ç§»å‹•å¤‰æ›´</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="ç§»å‹•ä½ä¸‹">ç§»å‹•ä½ä¸‹</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="ç§»å‹•åœæ­¢">ç§»å‹•åœæ­¢</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="ç§»å‹•å¾Œé€€">ç§»å‹•å¾Œé€€</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="è‡ªç„¶æ°—">è‡ªç„¶æ°—</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="æ°—(ç‰›)">æ°—(ç‰›)</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="æ°—(ãƒãƒ“)">æ°—(ãƒãƒ“)</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="å¾ã€…æ°—">å¾ã€…æ°—</button>
                            <button type="button" class="select-button" data-group="skillType" data-value="æ°—è»½æ¸›">æ°—è»½æ¸›</button>
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="number" id="skillValue" placeholder="æ•°å€¤" style="width: 80px;">
                            <select id="skillUnit" style="width: 80px;">
                                <option value="+%">+%</option>
                                <option value="-%">-%</option>
                                <option value="Ã—">Ã—</option>
                                <option value="+">+</option>
                                <option value="-">-</option>
                            </select>
                            <input type="text" id="skillCondition" placeholder="æ¡ä»¶ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰" style="flex: 1;">
                            <button class="btn" onclick="addSkillBuff()" style="padding: 8px 15px;">è¿½åŠ </button>
                        </div>
                        <div id="skillsList" class="buffs-list"></div>
                    </div>
                </div>

                <!-- ç·¨æˆç‰¹æŠ€å…¥åŠ› -->
                <div class="form-group">
                    <label>ç·¨æˆç‰¹æŠ€</label>
                    <div class="buff-input-area">
                        <div class="button-group">
                            <label>å¯¾è±¡</label>
                            <button type="button" class="select-button" data-group="formationTarget" data-value="å‘³æ–¹å…¨å“¡">å‘³æ–¹å…¨å“¡</button>
                            <button type="button" class="select-button" data-group="formationTarget" data-value="å‘³æ–¹è»èˆ¹">å‘³æ–¹è»èˆ¹</button>
                            <button type="button" class="select-button" data-group="formationTarget" data-value="å‘³æ–¹æ°´åŸ">å‘³æ–¹æ°´åŸ</button>
                        </div>
                        <div class="button-group">
                            <label>ãƒãƒ•ç¨®</label>
                            <button type="button" class="select-button" data-group="formationType" data-value="æ”»æ’ƒå›ºå®š">æ”»æ’ƒå›ºå®š</button>
                            <button type="button" class="select-button" data-group="formationType" data-value="æ”»æ’ƒå‰²åˆ">æ”»æ’ƒå‰²åˆ</button>
                            <button type="button" class="select-button" data-group="formationType" data-value="é˜²å¾¡">é˜²å¾¡</button>
                            <button type="button" class="select-button" data-group="formationType" data-value="è€ä¹…">è€ä¹…</button>
                            <button type="button" class="select-button" data-group="formationType" data-value="æ°—">æ°—</button>
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="number" id="formationValue" placeholder="æ•°å€¤" style="width: 80px;">
                            <select id="formationUnit" style="width: 80px;">
                                <option value="+%">+%</option>
                                <option value="+">+</option>
                                <option value="-">-</option>
                            </select>
                            <input type="text" id="formationCondition" placeholder="æ¡ä»¶ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰" style="flex: 1;">
                            <button class="btn" onclick="addFormationBuff()" style="padding: 8px 15px;">è¿½åŠ </button>
                        </div>
                        <div id="formationsList" class="buffs-list"></div>
                    </div>
                </div>

                <!-- è¨ˆç•¥å…¥åŠ› -->
                <div class="form-group">
                    <label>è¨ˆç•¥</label>
                    <div class="buff-input-area">
                        <div class="button-group">
                            <label>å¯¾è±¡</label>
                            <button type="button" class="select-button" data-group="strategyTarget" data-value="è‡ªèº«">è‡ªèº«</button>
                            <button type="button" class="select-button" data-group="strategyTarget" data-value="å‘³æ–¹å°„ç¨‹å†…">å‘³æ–¹å°„ç¨‹å†…</button>
                            <button type="button" class="select-button" data-group="strategyTarget" data-value="ä¼å…µå°„ç¨‹å†…">ä¼å…µå°„ç¨‹å†…</button>
                        </div>
                        <div class="button-group">
                            <label>ãƒãƒ•ç¨®</label>
                            <button type="button" class="select-button" data-group="strategyType" data-value="æ”»æ’ƒå›ºå®š">æ”»æ’ƒå›ºå®š</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="æ”»æ’ƒå‰²åˆ">æ”»æ’ƒå‰²åˆ</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="ä¸ãƒ€ãƒ¡">ä¸ãƒ€ãƒ¡</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="ä¸ãˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸">ä¸ãˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="è¢«ãƒ€ãƒ¡">è¢«ãƒ€ãƒ¡</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="é˜²å¾¡">é˜²å¾¡</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="é˜²å¾¡ãƒ‡ãƒãƒ•å›ºå®š">é˜²å¾¡ãƒ‡ãƒãƒ•å›ºå®š</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="é˜²å¾¡ãƒ‡ãƒãƒ•å‰²åˆ">é˜²å¾¡ãƒ‡ãƒãƒ•å‰²åˆ</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="æ”»æ’ƒãƒ‡ãƒãƒ•å›ºå®š">æ”»æ’ƒãƒ‡ãƒãƒ•å›ºå®š</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="æ”»æ’ƒãƒ‡ãƒãƒ•å‰²åˆ">æ”»æ’ƒãƒ‡ãƒãƒ•å‰²åˆ</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="é€Ÿåº¦">é€Ÿåº¦</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="éš™">éš™</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="å°„ç¨‹å›ºå®š">å°„ç¨‹å›ºå®š</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="å°„ç¨‹å‰²åˆ">å°„ç¨‹å‰²åˆ</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="ç§»å‹•å¤‰æ›´">ç§»å‹•å¤‰æ›´</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="ç§»å‹•ä½ä¸‹">ç§»å‹•ä½ä¸‹</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="ç§»å‹•åœæ­¢">ç§»å‹•åœæ­¢</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="ç§»å‹•å¾Œé€€">ç§»å‹•å¾Œé€€</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="è‡ªç„¶æ°—">è‡ªç„¶æ°—</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="æ°—(ç‰›)">æ°—(ç‰›)</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="æ°—(ãƒãƒ“)">æ°—(ãƒãƒ“)</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="å¾ã€…æ°—">å¾ã€…æ°—</button>
                            <button type="button" class="select-button" data-group="strategyType" data-value="æ°—è»½æ¸›">æ°—è»½æ¸›</button>
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="number" id="strategyValue" placeholder="æ•°å€¤" style="width: 80px;">
                            <select id="strategyUnit" style="width: 80px;">
                                <option value="+%">+%</option>
                                <option value="-%">-%</option>
                                <option value="Ã—">Ã—</option>
                                <option value="+">+</option>
                                <option value="-">-</option>
                            </select>
                            <input type="text" id="strategyCondition" placeholder="æ¡ä»¶ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰" style="flex: 1;">
                            <button class="btn" onclick="addStrategyBuff()" style="padding: 8px 15px;">è¿½åŠ </button>
                        </div>
                        <div id="strategiesList" class="buffs-list"></div>
                    </div>
                </div>

                <button class="btn" id="submitBtn" onclick="submitCharacter()">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ </button>
                <button class="btn" id="cancelEditBtn" onclick="cancelEdit()" style="background: #95a5a6; display: none; margin-left: 10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>

            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                <h3>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button class="btn" onclick="exportCharacters()" style="background: #43e97b;">
                        ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn" onclick="importCharacters()" style="background: #4facfe;">
                        ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn" onclick="exportFormations()" style="background: #fd79a8;">
                        ç·¨æˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn" onclick="importFormations()" style="background: #f093fb;">
                        ç·¨æˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn" onclick="exportAllData()" style="background: #667eea;">
                        å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                </div>
                <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileSelect(event)">
                <p style="margin-top: 10px; font-size: 12px; color: #666;">
                    â€» ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸãƒ‡ãƒ¼ã‚¿ã¯JSONå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™<br>
                    â€» ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ ã•ã‚Œã¾ã™ï¼ˆIDãŒé‡è¤‡ã™ã‚‹å ´åˆã¯ä¸Šæ›¸ãï¼‰
                </p>
            </div>

            <h3>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è¦§</h3>
            <div class="character-grid" id="characterGrid"></div>
        </div>

        <div id="formation" class="tab-content">
            <h2>ç·¨æˆä½œæˆ</h2>

            <div class="character-selection">
                <h3>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ãƒ»å‰Šé™¤ï¼‰</h3>
                <div class="character-grid compact-grid" id="availableCharacters"></div>
            </div>

            <div class="formation-section">
                <h3>ç·¨æˆãƒ¡ãƒ³ãƒãƒ¼ï¼ˆ<span id="memberCount">0</span>/8ï¼‰</h3>
                <div class="formation-grid" id="formationGrid">
                    <div class="formation-slot empty" data-slot="0">ç©ºã</div>
                    <div class="formation-slot empty" data-slot="1">ç©ºã</div>
                    <div class="formation-slot empty" data-slot="2">ç©ºã</div>
                    <div class="formation-slot empty" data-slot="3">ç©ºã</div>
                    <div class="formation-slot empty" data-slot="4">ç©ºã</div>
                    <div class="formation-slot empty" data-slot="5">ç©ºã</div>
                    <div class="formation-slot empty" data-slot="6">ç©ºã</div>
                    <div class="formation-slot empty" data-slot="7">ç©ºã</div>
                </div>
                <div class="formation-actions">
                    <input type="text" id="formationName" placeholder="ç·¨æˆåã‚’å…¥åŠ›" />
                    <button class="btn" onclick="saveFormation()">ç·¨æˆã‚’ä¿å­˜</button>
                    <button class="btn" onclick="clearFormation()" style="background: #ff4757;">ç·¨æˆã‚’ã‚¯ãƒªã‚¢</button>
                </div>
            </div>

            <div class="chart-section">
                <h3>ç·¨æˆãƒãƒ•/ãƒ‡ãƒãƒ•å¼·åº¦</h3>
                <div class="bar-chart" id="barChart"></div>
            </div>

            <div class="saved-formations">
                <h3>ä¿å­˜ã—ãŸç·¨æˆ</h3>
                <div id="savedFormationsList"></div>
            </div>
        </div>

        <div id="comparison" class="tab-content">
            <h2>ç·¨æˆæ¯”è¼ƒ</h2>

            <div class="comparison-section">
                <h3>æ¯”è¼ƒã™ã‚‹ç·¨æˆã‚’é¸æŠ</h3>
                <div id="formationSelector"></div>
            </div>

            <div class="comparison-chart-section">
                <h3>ãƒãƒ•/ãƒ‡ãƒãƒ•å¼·åº¦æ¯”è¼ƒ</h3>
                <div id="comparisonChart"></div>
            </div>
        </div>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†
        let characters = [];
        let currentFormation = [];
        let savedFormations = [];
        let selectedFormationsForComparison = [];

        // ãƒãƒ•å…¥åŠ›ç”¨ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿
        let tempSkills = [];
        let tempFormationSkills = [];
        let tempStrategies = [];

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
        let isEditMode = false;
        let editingCharacterId = null;

        // ãƒœã‚¿ãƒ³é¸æŠã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // å…¨ã¦ã®select-buttonã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            document.querySelectorAll('.select-button').forEach(button => {
                button.addEventListener('click', function() {
                    const group = this.dataset.group;

                    // è¤‡æ•°é¸æŠå¯èƒ½ãªãƒœã‚¿ãƒ³ã®å ´åˆ
                    if (this.classList.contains('multi-select')) {
                        // ãƒˆã‚°ãƒ«ï¼ˆè¿½åŠ /å‰Šé™¤ï¼‰
                        this.classList.toggle('active');
                    } else {
                        // å˜ä¸€é¸æŠã®å ´åˆ
                        // åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã®ä»–ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ activeã‚’å‰Šé™¤
                        document.querySelectorAll(`[data-group="${group}"]`).forEach(btn => {
                            btn.classList.remove('active');
                        });
                        // ã“ã®ãƒœã‚¿ãƒ³ã«activeã‚’è¿½åŠ 
                        this.classList.add('active');
                    }
                });
            });
        });

        // é¸æŠã•ã‚ŒãŸå€¤ã‚’å–å¾—ï¼ˆå˜ä¸€é¸æŠï¼‰
        function getSelectedValue(group) {
            const activeButton = document.querySelector(`[data-group="${group}"].active`);
            return activeButton ? activeButton.dataset.value : '';
        }

        // é¸æŠã•ã‚ŒãŸå€¤ã‚’å–å¾—ï¼ˆè¤‡æ•°é¸æŠï¼‰
        function getSelectedValues(group) {
            const activeButtons = document.querySelectorAll(`[data-group="${group}"].active`);
            return Array.from(activeButtons).map(btn => btn.dataset.value);
        }

        // LocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿
        function loadData() {
            const saved = localStorage.getItem('shiroProCharacters');
            if (saved) {
                characters = JSON.parse(saved);
            } else {
                // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
                characters = [
                    {
                        id: 1,
                        name: 'ãƒ‰ãƒ¬ãƒƒãƒ‰ãƒãƒ¼ãƒˆ',
                        period: '',
                        weapon: 'è»èˆ¹',
                        weaponRange: 'é ',
                        weaponType: 'ç‰©',
                        placement: 'é ',
                        attributes: ['æ°´'],
                        skills: ['è‡ªèº«/ç›´æ’ƒ+100%', 'è‡ªèº«/è¢«ãƒ€ãƒ¡-40%', 'æ•µå°„ç¨‹å†…/è¢«ãƒ€ãƒ¡+40%', 'å‘³æ–¹å…¨è»èˆ¹/ä¸ãƒ€ãƒ¡Ã—1.2ï¼ˆæ°´ä¸Šæ™‚ï¼‰'],
                        formationSkills: ['å‘³æ–¹è»èˆ¹/è€ä¹…+10%', 'å‘³æ–¹è»èˆ¹/é˜²å¾¡+10%', 'å‘³æ–¹è»èˆ¹/æ”»æ’ƒ+10%', 'å·¨å¤§åŒ–æ°—-2'],
                        strategies: ['å‘³æ–¹å°„ç¨‹å†…/æ”»æ’ƒ+120', 'å‘³æ–¹å°„ç¨‹å†…/å°„ç¨‹+30']
                    },
                    {
                        id: 2,
                        name: 'é•·ç¯ åŸ',
                        period: 'å«',
                        weapon: 'é‰„ç ²',
                        weaponRange: 'é ',
                        weaponType: 'ç‰©',
                        placement: 'é ',
                        attributes: ['å¹³'],
                        skills: ['å‘³æ–¹å°„ç¨‹å†…/ä¸ãƒ€ãƒ¡+40%', 'æ•µå°„ç¨‹å†…/é˜²å¾¡-30%', 'è‡ªèº«/ä¸ãƒ€ãƒ¡Ã—1.3ï¼ˆè¨ˆç•¥ä¸­ï¼‰'],
                        formationSkills: [],
                        strategies: ['å¯¾è±¡/å°„ç¨‹Ã—1.3', 'å¯¾è±¡/æ”»æ’ƒéš™0', 'å¯¾è±¡/æ”»æ’ƒ+10%ï¼ˆç´¯ç©æœ€å¤§140%ï¼‰']
                    },
                    {
                        id: 3,
                        name: 'ãƒ´ã‚£ã‚¯ãƒˆãƒªãƒ¼å·',
                        period: '',
                        weapon: 'è»èˆ¹',
                        weaponRange: 'é ',
                        weaponType: 'ç‰©',
                        placement: 'é ',
                        attributes: ['æ°´'],
                        skills: ['å‘³æ–¹å°„ç¨‹å†…/æ”»æ’ƒé€Ÿåº¦+40%', 'å‘³æ–¹å°„ç¨‹å†…/éš™-40%', 'å‘³æ–¹å…¨æ°´åŸ/æ”»æ’ƒ+40%', 'å‘³æ–¹å…¨æ°´åŸ/ä¸ãƒ€ãƒ¡+40%', 'è‡ªèº«/æ°—+2ï¼ˆæ°´ä¸Šãƒ»æ•µæ’ƒç ´æ™‚ï¼‰'],
                        formationSkills: ['å‘³æ–¹è»èˆ¹/æ°—+1ï¼ˆæ•µæ’ƒç ´æ™‚ï¼‰'],
                        strategies: ['è‡ªèº«/æ”»æ’ƒå¯¾è±¡+3', 'è‡ªèº«/6é€£ç¶šæ”»æ’ƒ']
                    }
                ];
            }
            renderCharacters();
            loadFormations();
        }

        // LocalStorageã«ä¿å­˜
        function saveData() {
            localStorage.setItem('shiroProCharacters', JSON.stringify(characters));
        }

        // ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        let currentImportType = 'characters'; // 'characters', 'formations', 'all'

        // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportCharacters() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            downloadJSON(characters, `shiro-pro-characters-${timestamp}.json`);
            alert('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
        }

        // ç·¨æˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportFormations() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            downloadJSON(savedFormations, `shiro-pro-formations-${timestamp}.json`);
            alert('ç·¨æˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportAllData() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const allData = {
                characters: characters,
                formations: savedFormations,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            downloadJSON(allData, `shiro-pro-all-data-${timestamp}.json`);
            alert('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importCharacters() {
            currentImportType = 'characters';
            document.getElementById('fileInput').click();
        }

        // ç·¨æˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importFormations() {
            currentImportType = 'formations';
            document.getElementById('fileInput').click();
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (currentImportType === 'characters') {
                        importCharactersData(data);
                    } else if (currentImportType === 'formations') {
                        importFormationsData(data);
                    }

                    // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
                    event.target.value = '';
                } catch (error) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
        function importCharactersData(data) {
            let importedData = [];

            // å…¨ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å ´åˆ
            if (data.characters && Array.isArray(data.characters)) {
                importedData = data.characters;
            }
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é…åˆ—ã®å ´åˆ
            else if (Array.isArray(data)) {
                importedData = data;
            }
            else {
                alert('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™');
                return;
            }

            // ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒ¼ã‚¸ï¼ˆIDãŒé‡è¤‡ã™ã‚‹å ´åˆã¯ä¸Šæ›¸ãï¼‰
            importedData.forEach(newChar => {
                const existingIndex = characters.findIndex(c => c.id === newChar.id);
                if (existingIndex >= 0) {
                    characters[existingIndex] = newChar;
                } else {
                    characters.push(newChar);
                }
            });

            saveData();
            renderCharacters();
            alert(`${importedData.length}ä»¶ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
        }

        // ç·¨æˆãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
        function importFormationsData(data) {
            let importedData = [];

            // å…¨ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å ´åˆ
            if (data.formations && Array.isArray(data.formations)) {
                importedData = data.formations;
            }
            // ç·¨æˆé…åˆ—ã®å ´åˆ
            else if (Array.isArray(data)) {
                importedData = data;
            }
            else {
                alert('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™');
                return;
            }

            // ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒ¼ã‚¸ï¼ˆIDãŒé‡è¤‡ã™ã‚‹å ´åˆã¯ä¸Šæ›¸ãï¼‰
            importedData.forEach(newFormation => {
                const existingIndex = savedFormations.findIndex(f => f.id === newFormation.id);
                if (existingIndex >= 0) {
                    savedFormations[existingIndex] = newFormation;
                } else {
                    savedFormations.push(newFormation);
                }
            });

            saveFormationsData();
            renderSavedFormations();
            alert(`${importedData.length}ä»¶ã®ç·¨æˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
        }

        // ç·¨æˆã‚’LocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿
        function loadFormations() {
            const saved = localStorage.getItem('shiroProFormations');
            if (saved) {
                savedFormations = JSON.parse(saved);
            }
            renderSavedFormations();
        }

        // ç·¨æˆã‚’LocalStorageã«ä¿å­˜
        function saveFormationsData() {
            localStorage.setItem('shiroProFormations', JSON.stringify(savedFormations));
        }

        // ãƒãƒ•è¿½åŠ æ©Ÿèƒ½
        function addSkillBuff() {
            const target = getSelectedValue('skillTarget');
            const type = getSelectedValue('skillType');
            const value = document.getElementById('skillValue').value;
            const unit = document.getElementById('skillUnit').value;
            const condition = document.getElementById('skillCondition').value.trim();

            if (!target || !type || !value) {
                alert('å…¨ã¦ã®é …ç›®ã‚’é¸æŠãƒ»å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const buffText = condition
                ? `${target}/${type}${unit}${value}ï¼ˆ${condition}ï¼‰`
                : `${target}/${type}${unit}${value}`;
            tempSkills.push(buffText);
            renderBuffsList('skillsList', tempSkills, 'skill');
        }

        function addFormationBuff() {
            const target = getSelectedValue('formationTarget');
            const type = getSelectedValue('formationType');
            const value = document.getElementById('formationValue').value;
            const unit = document.getElementById('formationUnit').value;
            const condition = document.getElementById('formationCondition').value.trim();

            if (!target || !type || !value) {
                alert('å…¨ã¦ã®é …ç›®ã‚’é¸æŠãƒ»å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const buffText = condition
                ? `${target}/${type}${unit}${value}ï¼ˆ${condition}ï¼‰`
                : `${target}/${type}${unit}${value}`;
            tempFormationSkills.push(buffText);
            renderBuffsList('formationsList', tempFormationSkills, 'formation');
        }

        function addStrategyBuff() {
            const target = getSelectedValue('strategyTarget');
            const type = getSelectedValue('strategyType');
            const value = document.getElementById('strategyValue').value;
            const unit = document.getElementById('strategyUnit').value;
            const condition = document.getElementById('strategyCondition').value.trim();

            if (!target || !type || !value) {
                alert('å…¨ã¦ã®é …ç›®ã‚’é¸æŠãƒ»å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const buffText = condition
                ? `${target}/${type}${unit}${value}ï¼ˆ${condition}ï¼‰`
                : `${target}/${type}${unit}${value}`;
            tempStrategies.push(buffText);
            renderBuffsList('strategiesList', tempStrategies, 'strategy');
        }

        function renderBuffsList(containerId, buffs, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            buffs.forEach((buff, index) => {
                const tag = document.createElement('div');
                tag.className = 'buff-tag';
                tag.innerHTML = `
                    <span>${buff}</span>
                    <button onclick="removeBuff('${type}', ${index})">Ã—</button>
                `;
                container.appendChild(tag);
            });
        }

        function removeBuff(type, index) {
            if (type === 'skill') {
                tempSkills.splice(index, 1);
                renderBuffsList('skillsList', tempSkills, 'skill');
            } else if (type === 'formation') {
                tempFormationSkills.splice(index, 1);
                renderBuffsList('formationsList', tempFormationSkills, 'formation');
            } else if (type === 'strategy') {
                tempStrategies.splice(index, 1);
                renderBuffsList('strategiesList', tempStrategies, 'strategy');
            }
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ ãƒ»æ›´æ–°
        function submitCharacter() {
            const name = document.getElementById('charName').value.trim();
            const period = document.getElementById('charPeriod').value.trim();
            const weapon = document.getElementById('charWeapon').value.trim();
            const weaponRange = getSelectedValue('weaponRange');
            const weaponType = getSelectedValue('weaponType');
            const placement = getSelectedValue('placement');
            const attributes = getSelectedValues('attribute');

            if (!name) {
                alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (isEditMode) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šæ—¢å­˜ã‚­ãƒ£ãƒ©ã‚’æ›´æ–°
                const char = characters.find(c => c.id === editingCharacterId);
                if (char) {
                    char.name = name;
                    char.period = period;
                    char.weapon = weapon;
                    char.weaponRange = weaponRange;
                    char.weaponType = weaponType;
                    char.placement = placement;
                    char.attributes = attributes;
                    char.skills = [...tempSkills];
                    char.formationSkills = [...tempFormationSkills];
                    char.strategies = [...tempStrategies];
                }
                isEditMode = false;
                editingCharacterId = null;
            } else {
                // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
                const newChar = {
                    id: Date.now(),
                    name,
                    period,
                    weapon,
                    weaponRange,
                    weaponType,
                    placement,
                    attributes,
                    skills: [...tempSkills],
                    formationSkills: [...tempFormationSkills],
                    strategies: [...tempStrategies]
                };
                characters.push(newChar);
            }

            saveData();
            renderCharacters();
            clearForm();
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
        function clearForm() {
            document.getElementById('charName').value = '';
            document.getElementById('charPeriod').value = '';
            document.getElementById('charWeapon').value = '';

            // æ¡ä»¶å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('skillValue').value = '';
            document.getElementById('skillCondition').value = '';
            document.getElementById('formationValue').value = '';
            document.getElementById('formationCondition').value = '';
            document.getElementById('strategyValue').value = '';
            document.getElementById('strategyCondition').value = '';

            // ãƒãƒ•ãƒªã‚¹ãƒˆã‚¯ãƒªã‚¢
            tempSkills = [];
            tempFormationSkills = [];
            tempStrategies = [];
            renderBuffsList('skillsList', tempSkills, 'skill');
            renderBuffsList('formationsList', tempFormationSkills, 'formation');
            renderBuffsList('strategiesList', tempStrategies, 'strategy');

            // å…¨ã¦ã®ãƒœã‚¿ãƒ³ã®é¸æŠã‚’è§£é™¤
            document.querySelectorAll('.select-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
            document.getElementById('formTitle').textContent = 'æ–°è¦ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ ';
            document.getElementById('submitBtn').textContent = 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¿½åŠ ';
            document.getElementById('cancelEditBtn').style.display = 'none';

            isEditMode = false;
            editingCharacterId = null;
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹
        function editCharacter(id) {
            const char = characters.find(c => c.id === id);
            if (!char) return;

            isEditMode = true;
            editingCharacterId = id;

            // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
            document.getElementById('charName').value = char.name;
            document.getElementById('charPeriod').value = char.period || '';
            document.getElementById('charWeapon').value = char.weapon;

            // ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’å¾©å…ƒ
            document.querySelectorAll('.select-button').forEach(btn => btn.classList.remove('active'));
            if (char.weaponRange) {
                const rangeBtn = document.querySelector(`[data-group="weaponRange"][data-value="${char.weaponRange}"]`);
                if (rangeBtn) rangeBtn.classList.add('active');
            }
            if (char.weaponType) {
                const typeBtn = document.querySelector(`[data-group="weaponType"][data-value="${char.weaponType}"]`);
                if (typeBtn) typeBtn.classList.add('active');
            }
            if (char.placement) {
                const placementBtn = document.querySelector(`[data-group="placement"][data-value="${char.placement}"]`);
                if (placementBtn) placementBtn.classList.add('active');
            }
            // å±æ€§ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’å¾©å…ƒï¼ˆè¤‡æ•°é¸æŠï¼‰
            const attributes = char.attributes || (char.attribute ? [char.attribute] : []); // å¾Œæ–¹äº’æ›æ€§
            attributes.forEach(attr => {
                const attrBtn = document.querySelector(`[data-group="attribute"][data-value="${attr}"]`);
                if (attrBtn) attrBtn.classList.add('active');
            });

            // ãƒãƒ•ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
            tempSkills = [...char.skills];
            tempFormationSkills = [...char.formationSkills];
            tempStrategies = [...char.strategies];
            renderBuffsList('skillsList', tempSkills, 'skill');
            renderBuffsList('formationsList', tempFormationSkills, 'formation');
            renderBuffsList('strategiesList', tempStrategies, 'strategy');

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒœã‚¿ãƒ³ã‚’å¤‰æ›´
            document.getElementById('formTitle').textContent = `ã€Œ${char.name}ã€ã‚’ç·¨é›†`;
            document.getElementById('submitBtn').textContent = 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ›´æ–°';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';

            // ãƒ•ã‚©ãƒ¼ãƒ ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.querySelector('.character-form').scrollIntoView({ behavior: 'smooth' });
        }

        // ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelEdit() {
            clearForm();
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‰Šé™¤
        function deleteCharacter(id) {
            if (confirm('ã“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                characters = characters.filter(c => c.id !== id);
                saveData();
                renderCharacters();
            }
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º
        function renderCharacters() {
            const grid = document.getElementById('characterGrid');
            grid.innerHTML = '';

            characters.forEach(char => {
                const card = document.createElement('div');
                card.className = 'character-card';
                const weaponInfo = `${char.weapon || ''}${char.weaponRange ? ` (${char.weaponRange}${char.weaponType ? '/' + char.weaponType : ''})` : ''}`;
                const placementInfo = char.placement ? ` [${char.placement}]` : '';
                const attributeInfo = char.attributes ? char.attributes.join('ãƒ»') : (char.attribute || ''); // å¾Œæ–¹äº’æ›æ€§
                card.innerHTML = `
                    <h3>${char.period ? `[${char.period}] ` : ''}${char.name}</h3>
                    <div class="meta">
                        ${weaponInfo}${placementInfo} | ${attributeInfo}
                    </div>
                    <div class="buffs">
                        <strong>ç‰¹æŠ€:</strong><br>
                        ${char.skills.slice(0, 2).join('<br>')}
                        ${char.skills.length > 2 ? '<br>...' : ''}
                    </div>
                    <button class="btn" onclick="editCharacter(${char.id}); event.stopPropagation();" style="padding: 5px 15px; font-size: 12px; margin-top: 10px; background: #43e97b;">ç·¨é›†</button>
                    <button class="btn delete-btn" onclick="deleteCharacter(${char.id}); event.stopPropagation();" style="padding: 5px 15px; font-size: 12px;">å‰Šé™¤</button>
                `;
                grid.appendChild(card);
            });
        }

        // ç·¨æˆç®¡ç†
        function addToFormation(charId) {
            if (currentFormation.length >= 8) {
                alert('ç·¨æˆã¯8äººã¾ã§ã§ã™');
                return;
            }

            if (currentFormation.includes(charId)) {
                alert('ã“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯æ—¢ã«ç·¨æˆã«å«ã¾ã‚Œã¦ã„ã¾ã™');
                return;
            }

            currentFormation.push(charId);
            renderFormation();
            renderAvailableCharacters();
        }

        function removeFromFormation(charId) {
            currentFormation = currentFormation.filter(id => id !== charId);
            renderFormation();
            renderAvailableCharacters();
        }

        function renderFormation() {
            const slots = document.querySelectorAll('.formation-slot');

            slots.forEach((slot, index) => {
                if (currentFormation[index]) {
                    const char = characters.find(c => c.id === currentFormation[index]);
                    if (char) {
                        const weaponInfo = `${char.weapon || ''}${char.weaponRange ? ` (${char.weaponRange}${char.weaponType ? '/' + char.weaponType : ''})` : ''}`;
                        const placementInfo = char.placement ? ` [${char.placement}]` : '';
                        const attributeInfo = char.attributes ? char.attributes.join('ãƒ»') : (char.attribute || '');
                        slot.className = 'formation-slot filled';
                        slot.innerHTML = `
                            <h4>${char.period ? `[${char.period}] ` : ''}${char.name}</h4>
                            <div class="meta">
                                ${weaponInfo}${placementInfo}<br>${attributeInfo}
                            </div>
                        `;
                        slot.onclick = () => removeFromFormation(char.id);
                    }
                } else {
                    slot.className = 'formation-slot empty';
                    slot.innerHTML = 'ç©ºã';
                    slot.onclick = null;
                }
            });

            document.getElementById('memberCount').textContent = currentFormation.length;
            renderBarChart();
        }

        // æ•°å€¤ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
        function extractBuffValue(effect) {
            // Ã—å½¢å¼ï¼ˆå€ç‡ï¼‰
            if (effect.includes('Ã—')) {
                const match = effect.match(/Ã—(\d+\.?\d*)/);
                if (match) {
                    const value = parseFloat(match[1]);
                    return { value: value, display: `Ã—${value}`, numeric: value * 100 }; // æ¯”è¼ƒç”¨ã«100å€
                }
            }
            // %å½¢å¼
            if (effect.includes('%')) {
                const match = effect.match(/([+-]?\d+)%/);
                if (match) {
                    const value = parseInt(match[1]);
                    return { value: value, display: `${value > 0 ? '+' : ''}${value}%`, numeric: Math.abs(value) };
                }
            }
            // å›ºå®šå€¤å½¢å¼
            const match = effect.match(/([+-]?\d+)/);
            if (match) {
                const value = parseInt(match[1]);
                return { value: value, display: `${value > 0 ? '+' : ''}${value}`, numeric: Math.abs(value) };
            }
            return null;
        }

        // éš™ã®æ•°å€¤ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°ï¼ˆç¬¦å·ã‚’åè»¢ã—ã¦ãƒãƒ•/ãƒ‡ãƒãƒ•ã¨ã—ã¦æ‰±ã†ï¼‰
        function extractGapValue(effect) {
            // %å½¢å¼
            if (effect.includes('%')) {
                const match = effect.match(/([+-]?\d+)%/);
                if (match) {
                    const originalValue = parseInt(match[1]);
                    // ç¬¦å·ã‚’åè»¢ï¼šéš™-40% â†’ +40%ï¼ˆãƒãƒ•ï¼‰ã€éš™+40% â†’ -40%ï¼ˆãƒ‡ãƒãƒ•ï¼‰
                    const value = -originalValue;
                    return {
                        value: value,
                        display: `${value > 0 ? '+' : ''}${value}%`,
                        numeric: Math.abs(value),
                        isBuff: value > 0  // æ­£ã®å€¤ãªã‚‰ãƒãƒ•ã€è² ã®å€¤ãªã‚‰ãƒ‡ãƒãƒ•
                    };
                }
            }
            // å›ºå®šå€¤å½¢å¼
            const match = effect.match(/([+-]?\d+)/);
            if (match) {
                const originalValue = parseInt(match[1]);
                const value = -originalValue;
                return {
                    value: value,
                    display: `${value > 0 ? '+' : ''}${value}`,
                    numeric: Math.abs(value),
                    isBuff: value > 0
                };
            }
            return null;
        }

        // ãƒãƒ•/ãƒ‡ãƒãƒ•ã‚’è©³ç´°ã«é›†è¨ˆï¼ˆå®Ÿéš›ã®æ•°å€¤ï¼‰
        function calculateDetailedBuffScores() {
            const formationChars = currentFormation.map(id => characters.find(c => c.id === id)).filter(c => c);

            const scores = {
                'æ°—ç®¡ç†': {
                    'è‡ªç„¶æ°—': { value: null, display: '-', numeric: 0 },
                    'æ°—ï¼ˆç‰›ï¼‰': { value: null, display: '-', numeric: 0 },
                    'æ°—ï¼ˆãƒãƒ“ï¼‰': { value: null, display: '-', numeric: 0 },
                    'å¾ã€…æ°—': { value: null, display: '-', numeric: 0 },
                    'æ°—è»½æ¸›': { value: null, display: '-', numeric: 0 }
                },
                'é€Ÿåº¦': {
                    'é€Ÿåº¦ãƒãƒ•': { value: null, display: '-', numeric: 0 },
                    'é€Ÿåº¦ãƒ‡ãƒãƒ•': { value: null, display: '-', numeric: 0 },
                    'éš™çŸ­ç¸®': { value: null, display: '-', numeric: 0 },
                    'éš™å¢—åŠ ': { value: null, display: '-', numeric: 0 }
                },
                'è¨ˆç•¥': {
                    'è¨ˆç•¥çŸ­ç¸®': { value: null, display: '-', numeric: 0 }
                },
                'ç§»å‹•é€Ÿåº¦': {
                    'ç§»å‹•å¤‰æ›´': { value: null, display: '-', numeric: 0 },
                    'ç§»å‹•ä½ä¸‹': { value: null, display: '-', numeric: 0 },
                    'ç§»å‹•åœæ­¢': { value: null, display: '-', numeric: 0 },
                    'ç§»å‹•å¾Œé€€': { value: null, display: '-', numeric: 0 }
                },
                'å°„ç¨‹': {
                    'å°„ç¨‹å›ºå®š': { value: null, display: '-', numeric: 0, isFixed: true },
                    'å°„ç¨‹å‰²åˆ': { value: null, display: '-', numeric: 0 },
                    'å°„ç¨‹ãƒ‡ãƒãƒ•': { value: null, display: '-', numeric: 0 }
                },
                'æ”»æ’ƒç³»': {
                    'æ”»æ’ƒå›ºå®š': { value: null, display: '-', numeric: 0, isFixed: true },
                    'æ”»æ’ƒå‰²åˆ': { value: null, display: '-', numeric: 0 },
                    'ä¸ãƒ€ãƒ¡ãƒãƒ•': { value: null, display: '-', numeric: 0 },
                    'ä¸ãˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸ãƒãƒ•': { value: null, display: '-', numeric: 0 },
                    'è¢«ãƒ€ãƒ¡ãƒãƒ•': { value: null, display: '-', numeric: 0 },
                    'é‡è¤‡ãƒãƒ•': { value: null, display: '-', numeric: 0 },
                    'é˜²å¾¡ç„¡è¦–': { value: null, display: '-', numeric: 0 },
                    'é˜²å¾¡ãƒ‡ãƒãƒ•å›ºå®š': { value: null, display: '-', numeric: 0, isFixed: true },
                    'é˜²å¾¡ãƒ‡ãƒãƒ•å‰²åˆ': { value: null, display: '-', numeric: 0 }
                },
                'é˜²å¾¡ç³»': {
                    'è¢«ãƒ€ãƒ¡è»½æ¸›': { value: null, display: '-', numeric: 0 },
                    'ä¸ãƒ€ãƒ¡ãƒ‡ãƒãƒ•': { value: null, display: '-', numeric: 0 },
                    'é˜²å¾¡ãƒãƒ•': { value: null, display: '-', numeric: 0 },
                    'æ”»æ’ƒãƒ‡ãƒãƒ•å›ºå®š': { value: null, display: '-', numeric: 0, isFixed: true },
                    'æ”»æ’ƒãƒ‡ãƒãƒ•å‰²åˆ': { value: null, display: '-', numeric: 0 }
                }
            };

            function updateMax(category, item, newValue) {
                if (!newValue) return;
                const current = scores[category][item];

                // å›ºå®šå€¤ãƒãƒ•ã¯åŠ ç®—
                if (current.isFixed) {
                    const totalValue = (current.value || 0) + newValue.value;
                    const totalNumeric = (current.numeric || 0) + newValue.numeric;
                    scores[category][item] = {
                        value: totalValue,
                        display: totalValue > 0 ? `+${totalValue}` : `${totalValue}`,
                        numeric: totalNumeric,
                        isFixed: true
                    };
                } else {
                    // å‰²åˆãƒãƒ•ã¯æœ€å¤§å€¤ã‚’æ¡ç”¨
                    if (current.value === null || newValue.numeric > current.numeric) {
                        scores[category][item] = { ...newValue, isFixed: false };
                    }
                }
            }

            formationChars.forEach(char => {
                const allEffects = [...char.skills, ...char.formationSkills, ...char.strategies];

                allEffects.forEach(effect => {
                    // æ°—ç®¡ç†
                    if (effect.includes('æ°—-')) {
                        updateMax('æ°—ç®¡ç†', 'æ°—è»½æ¸›', extractBuffValue(effect));
                    }
                    if (effect.includes('æ°—+') && effect.includes('æ’ƒç ´')) {
                        const val = extractBuffValue(effect);
                        if (val && val.value === 2) updateMax('æ°—ç®¡ç†', 'æ°—ï¼ˆç‰›ï¼‰', val);
                        else if (val && val.value === 1) updateMax('æ°—ç®¡ç†', 'æ°—ï¼ˆãƒãƒ“ï¼‰', val);
                    }

                    // é€Ÿåº¦
                    if (effect.includes('æ”»æ’ƒé€Ÿåº¦+') || (effect.includes('é€Ÿåº¦+') && !effect.includes('ç§»å‹•'))) {
                        updateMax('é€Ÿåº¦', 'é€Ÿåº¦ãƒãƒ•', extractBuffValue(effect));
                    }
                    // éš™ã®å‡¦ç†ï¼ˆç¬¦å·ã‚’åè»¢ã—ã¦æ‰±ã†ï¼‰
                    if (effect.includes('éš™-') || effect.includes('éš™+')) {
                        const gapValue = extractGapValue(effect);
                        if (gapValue) {
                            if (gapValue.isBuff) {
                                // éš™-XX% â†’ éš™çŸ­ç¸®+XX%ï¼ˆãƒãƒ•ï¼‰
                                updateMax('é€Ÿåº¦', 'éš™çŸ­ç¸®', gapValue);
                            } else {
                                // éš™+XX% â†’ éš™å¢—åŠ -XX%ï¼ˆãƒ‡ãƒãƒ•ï¼‰
                                updateMax('é€Ÿåº¦', 'éš™å¢—åŠ ', gapValue);
                            }
                        }
                    }
                    if (effect.includes('æ”»æ’ƒéš™0')) {
                        updateMax('é€Ÿåº¦', 'éš™çŸ­ç¸®', { value: 100, display: '+100%', numeric: 100 });
                    }

                    // å°„ç¨‹
                    if (effect.includes('å°„ç¨‹å›ºå®š')) {
                        updateMax('å°„ç¨‹', 'å°„ç¨‹å›ºå®š', extractBuffValue(effect));
                    } else if (effect.includes('å°„ç¨‹å‰²åˆ')) {
                        updateMax('å°„ç¨‹', 'å°„ç¨‹å‰²åˆ', extractBuffValue(effect));
                    } else if (effect.includes('å°„ç¨‹Ã—')) {
                        updateMax('å°„ç¨‹', 'å°„ç¨‹å‰²åˆ', extractBuffValue(effect));
                    } else if (effect.includes('å°„ç¨‹-')) {
                        updateMax('å°„ç¨‹', 'å°„ç¨‹ãƒ‡ãƒãƒ•', extractBuffValue(effect));
                    } else if (effect.includes('å°„ç¨‹+')) {
                        updateMax('å°„ç¨‹', 'å°„ç¨‹å›ºå®š', extractBuffValue(effect));
                    }

                    // æ”»æ’ƒç³»
                    if (effect.includes('æ”»æ’ƒå›ºå®š')) {
                        updateMax('æ”»æ’ƒç³»', 'æ”»æ’ƒå›ºå®š', extractBuffValue(effect));
                    } else if (effect.includes('æ”»æ’ƒå‰²åˆ')) {
                        updateMax('æ”»æ’ƒç³»', 'æ”»æ’ƒå‰²åˆ', extractBuffValue(effect));
                    } else if (effect.includes('æ”»æ’ƒ+')) {
                        updateMax('æ”»æ’ƒç³»', 'æ”»æ’ƒå›ºå®š', extractBuffValue(effect));
                    } else if (effect.includes('æ”»æ’ƒÃ—')) {
                        updateMax('æ”»æ’ƒç³»', 'æ”»æ’ƒå‰²åˆ', extractBuffValue(effect));
                    }
                    // ã€Œä¸ãˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸ã€ãŒå…ˆã«ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ˆã‚Šå…·ä½“çš„ãªæ–¹ã‚’å…ˆã«ï¼‰
                    if (effect.includes('ä¸ãˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸')) {
                        updateMax('æ”»æ’ƒç³»', 'ä¸ãˆã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸ãƒãƒ•', extractBuffValue(effect));
                    } else if (effect.includes('ä¸ãƒ€ãƒ¡-')) {
                        updateMax('é˜²å¾¡ç³»', 'ä¸ãƒ€ãƒ¡ãƒ‡ãƒãƒ•', extractBuffValue(effect));
                    } else if (effect.includes('ä¸ãƒ€ãƒ¡')) {
                        updateMax('æ”»æ’ƒç³»', 'ä¸ãƒ€ãƒ¡ãƒãƒ•', extractBuffValue(effect));
                    }
                    if (effect.includes('è¢«ãƒ€ãƒ¡+') || effect.includes('è¢«ãƒ€ãƒ¡Ã—')) {
                        updateMax('æ”»æ’ƒç³»', 'è¢«ãƒ€ãƒ¡ãƒãƒ•', extractBuffValue(effect));
                    }
                    // é˜²å¾¡ãƒ‡ãƒãƒ•
                    if (effect.includes('é˜²å¾¡ãƒ‡ãƒãƒ•å›ºå®š')) {
                        updateMax('æ”»æ’ƒç³»', 'é˜²å¾¡ãƒ‡ãƒãƒ•å›ºå®š', extractBuffValue(effect));
                    } else if (effect.includes('é˜²å¾¡ãƒ‡ãƒãƒ•å‰²åˆ')) {
                        updateMax('æ”»æ’ƒç³»', 'é˜²å¾¡ãƒ‡ãƒãƒ•å‰²åˆ', extractBuffValue(effect));
                    } else if (effect.includes('é˜²å¾¡-') && effect.includes('%')) {
                        updateMax('æ”»æ’ƒç³»', 'é˜²å¾¡ãƒ‡ãƒãƒ•å‰²åˆ', extractBuffValue(effect));
                    } else if (effect.includes('é˜²å¾¡-')) {
                        updateMax('æ”»æ’ƒç³»', 'é˜²å¾¡ãƒ‡ãƒãƒ•å›ºå®š', extractBuffValue(effect));
                    }

                    // é˜²å¾¡ç³»
                    if (effect.includes('è¢«ãƒ€ãƒ¡-')) {
                        updateMax('é˜²å¾¡ç³»', 'è¢«ãƒ€ãƒ¡è»½æ¸›', extractBuffValue(effect));
                    }
                    if (effect.includes('é˜²å¾¡+') || effect.includes('é˜²å¾¡Ã—')) {
                        updateMax('é˜²å¾¡ç³»', 'é˜²å¾¡ãƒãƒ•', extractBuffValue(effect));
                    }
                    // æ”»æ’ƒãƒ‡ãƒãƒ•
                    if (effect.includes('æ”»æ’ƒãƒ‡ãƒãƒ•å›ºå®š')) {
                        updateMax('é˜²å¾¡ç³»', 'æ”»æ’ƒãƒ‡ãƒãƒ•å›ºå®š', extractBuffValue(effect));
                    } else if (effect.includes('æ”»æ’ƒãƒ‡ãƒãƒ•å‰²åˆ')) {
                        updateMax('é˜²å¾¡ç³»', 'æ”»æ’ƒãƒ‡ãƒãƒ•å‰²åˆ', extractBuffValue(effect));
                    }

                    // ç§»å‹•é€Ÿåº¦
                    if (effect.includes('ç§»å‹•å¤‰æ›´')) {
                        updateMax('ç§»å‹•é€Ÿåº¦', 'ç§»å‹•å¤‰æ›´', extractBuffValue(effect));
                    }
                    if (effect.includes('ç§»å‹•ä½ä¸‹')) {
                        updateMax('ç§»å‹•é€Ÿåº¦', 'ç§»å‹•ä½ä¸‹', extractBuffValue(effect));
                    }
                    if (effect.includes('ç§»å‹•åœæ­¢')) {
                        updateMax('ç§»å‹•é€Ÿåº¦', 'ç§»å‹•åœæ­¢', { value: 100, display: 'åœæ­¢', numeric: 100 });
                    }
                    if (effect.includes('ç§»å‹•å¾Œé€€')) {
                        updateMax('ç§»å‹•é€Ÿåº¦', 'ç§»å‹•å¾Œé€€', extractBuffValue(effect));
                    }
                });
            });

            return scores;
        }

        function renderBarChart() {
            const chartDiv = document.getElementById('barChart');

            if (currentFormation.length === 0) {
                chartDiv.innerHTML = '<p style="color: #999; text-align: center;">ç·¨æˆãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã™ã‚‹ã¨ã€ãƒãƒ•/ãƒ‡ãƒãƒ•å¼·åº¦ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>';
                return;
            }

            const scores = calculateDetailedBuffScores();
            chartDiv.innerHTML = '';

            // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®è‰²å®šç¾©
            const categoryColors = {
                'æ°—ç®¡ç†': '#4facfe',
                'é€Ÿåº¦': '#43e97b',
                'è¨ˆç•¥': '#9b59b6',
                'ç§»å‹•é€Ÿåº¦': '#f39c12',
                'å°„ç¨‹': '#e74c3c',
                'æ”»æ’ƒç³»': '#fd79a8',
                'é˜²å¾¡ç³»': '#95a5a6'
            };

            // å‡¡ä¾‹ã‚’ä½œæˆ
            const legend = document.createElement('div');
            legend.className = 'chart-legend';
            Object.entries(categoryColors).forEach(([category, color]) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background: ${color}"></div>
                    <span>${category}</span>
                `;
                legend.appendChild(item);
            });
            chartDiv.appendChild(legend);

            // å…¨ã¦ã®ãƒãƒ•ã‚’1ã¤ã®ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªæ£’ã‚°ãƒ©ãƒ•ã«è¡¨ç¤º
            const barsContainer = document.createElement('div');
            barsContainer.className = 'compact-bars';

            // çµ±ä¸€åŸºæº–å€¤ï¼ˆå…¨ã‚«ãƒ†ã‚´ãƒªå…±é€šï¼‰
            const maxBaseValue = 100;

            Object.entries(scores).forEach(([category, items], catIndex) => {
                // ã‚«ãƒ†ã‚´ãƒªã®åŒºåˆ‡ã‚Šç·šï¼ˆæœ€åˆä»¥å¤–ï¼‰
                if (catIndex > 0) {
                    const divider = document.createElement('div');
                    divider.className = 'category-divider';
                    barsContainer.appendChild(divider);
                }

                Object.entries(items).forEach(([itemName, buffData]) => {
                    // å›ºå®šå€¤ãƒãƒ•ã¯é™¤å¤–
                    if (buffData.isFixed) return;

                    const barItem = document.createElement('div');
                    barItem.className = 'compact-bar-item';

                    // çµ±ä¸€åŸºæº–å€¤ï¼ˆ100ï¼‰ã«å¯¾ã™ã‚‹å‰²åˆ
                    const height = buffData.numeric > 0 ? Math.min((buffData.numeric / maxBaseValue) * 100, 100) : 0;

                    // ãƒ‡ãƒãƒ•é …ç›®ï¼ˆåå‰ã«ã€Œãƒ‡ãƒãƒ•ã€ã€Œå¢—åŠ ã€ã€Œä½ä¸‹ã€ãªã©ã‚’å«ã‚€ï¼‰ã¯æš—ã„è‰²ã§è¡¨ç¤º
                    let color = categoryColors[category];
                    const isDebuff = itemName.includes('ãƒ‡ãƒãƒ•') || itemName.includes('å¢—åŠ ') ||
                                    itemName.includes('ä½ä¸‹') || itemName.includes('å¾Œé€€') || itemName.includes('åœæ­¢');
                    if (isDebuff) {
                        // ãƒ‡ãƒãƒ•ã¯å°‘ã—æš—ã‚ã®è‰²ã«å¤‰æ›´ï¼ˆä¸é€æ˜åº¦ã‚’ä¸‹ã’ã‚‹ï¼‰
                        color = categoryColors[category] + '80'; // 50%ã®ä¸é€æ˜åº¦
                    }

                    barItem.innerHTML = `
                        <div class="compact-bar-container">
                            <div class="compact-bar-fill" style="height: ${height}%; background: ${color}">
                                <div class="compact-bar-value" style="color: ${color}">${buffData.display}</div>
                            </div>
                        </div>
                        <div class="compact-bar-label">${itemName}</div>
                    `;

                    barsContainer.appendChild(barItem);
                });
            });

            chartDiv.appendChild(barsContainer);

            // å›ºå®šå€¤ãƒãƒ•ã®åˆè¨ˆã‚’åˆ¥è¡¨ç¤º
            const fixedValuesDiv = document.createElement('div');
            fixedValuesDiv.style.cssText = 'margin-top: 30px; padding: 20px; background: white; border-radius: 10px; border: 2px solid #e0e0e0;';

            let hasFixedValues = false;
            let fixedValuesHTML = '<h4 style="margin-bottom: 15px; color: #667eea;">å›ºå®šå€¤ãƒãƒ•åˆè¨ˆ</h4><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">';

            Object.entries(scores).forEach(([category, items]) => {
                Object.entries(items).forEach(([itemName, buffData]) => {
                    if (buffData.isFixed && buffData.numeric > 0) {
                        hasFixedValues = true;
                        const color = categoryColors[category];
                        fixedValuesHTML += `
                            <div style="padding: 10px; background: ${color}20; border-left: 4px solid ${color}; border-radius: 5px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 3px;">${itemName}</div>
                                <div style="font-size: 18px; font-weight: bold; color: ${color};">${buffData.display}</div>
                            </div>
                        `;
                    }
                });
            });

            fixedValuesHTML += '</div>';

            if (hasFixedValues) {
                fixedValuesDiv.innerHTML = fixedValuesHTML;
                chartDiv.appendChild(fixedValuesDiv);
            }
        }

        function renderAvailableCharacters() {
            const grid = document.getElementById('availableCharacters');
            grid.innerHTML = '';

            characters.forEach(char => {
                const card = document.createElement('div');
                const isInFormation = currentFormation.includes(char.id);
                card.className = 'character-card' + (isInFormation ? ' in-formation' : '');

                // ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤ºï¼ˆåå‰ã®ã¿ï¼‰
                card.innerHTML = `
                    <h3>${char.period ? `[${char.period}] ` : ''}${char.name}</h3>
                `;

                // ã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ãƒ»å‰Šé™¤ã‚’ãƒˆã‚°ãƒ«
                if (isInFormation) {
                    card.onclick = () => removeFromFormation(char.id);
                    card.style.cursor = 'pointer';
                } else {
                    card.onclick = () => addToFormation(char.id);
                }

                grid.appendChild(card);
            });
        }

        // ç·¨æˆä¿å­˜
        function saveFormation() {
            if (currentFormation.length === 0) {
                alert('ç·¨æˆã«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
                return;
            }

            const name = document.getElementById('formationName').value.trim();
            if (!name) {
                alert('ç·¨æˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const formation = {
                id: Date.now(),
                name: name,
                members: [...currentFormation]
            };

            savedFormations.push(formation);
            saveFormationsData();
            renderSavedFormations();

            document.getElementById('formationName').value = '';
            alert('ç·¨æˆã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

        // ç·¨æˆã‚¯ãƒªã‚¢
        function clearFormation() {
            if (confirm('ç¾åœ¨ã®ç·¨æˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                currentFormation = [];
                renderFormation();
                renderAvailableCharacters();
            }
        }

        // ä¿å­˜ã—ãŸç·¨æˆã‚’è¡¨ç¤º
        function renderSavedFormations() {
            const list = document.getElementById('savedFormationsList');
            list.innerHTML = '';

            if (savedFormations.length === 0) {
                list.innerHTML = '<p style="color: #999; text-align: center;">ä¿å­˜ã—ãŸç·¨æˆã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            savedFormations.forEach(formation => {
                const card = document.createElement('div');
                card.className = 'saved-formation-card';

                const memberNames = formation.members
                    .map(id => {
                        const char = characters.find(c => c.id === id);
                        return char ? (char.period ? `[${char.period}] ${char.name}` : char.name) : 'ä¸æ˜';
                    })
                    .join('ã€');

                card.innerHTML = `
                    <div class="saved-formation-header">
                        <div class="saved-formation-name">${formation.name}</div>
                        <div class="saved-formation-actions">
                            <button class="btn" onclick="loadFormation(${formation.id})" style="padding: 5px 15px; font-size: 12px;">èª­è¾¼</button>
                            <button class="btn delete-btn" onclick="deleteSavedFormation(${formation.id})" style="padding: 5px 15px; font-size: 12px;">å‰Šé™¤</button>
                        </div>
                    </div>
                    <div class="saved-formation-members">
                        ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆ${formation.members.length}ï¼‰: ${memberNames}
                    </div>
                `;

                list.appendChild(card);
            });
        }

        // ç·¨æˆã‚’ãƒ­ãƒ¼ãƒ‰
        function loadFormation(id) {
            const formation = savedFormations.find(f => f.id === id);
            if (formation) {
                currentFormation = [...formation.members];
                renderFormation();
                renderAvailableCharacters();
            }
        }

        // ä¿å­˜ã—ãŸç·¨æˆã‚’å‰Šé™¤
        function deleteSavedFormation(id) {
            if (confirm('ã“ã®ç·¨æˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                savedFormations = savedFormations.filter(f => f.id !== id);
                saveFormationsData();
                renderSavedFormations();
            }
        }

        // ç·¨æˆæ¯”è¼ƒæ©Ÿèƒ½
        function renderFormationSelector() {
            const selector = document.getElementById('formationSelector');
            selector.innerHTML = '';

            if (savedFormations.length === 0) {
                selector.innerHTML = '<p style="color: #999; text-align: center;">ä¿å­˜ã—ãŸç·¨æˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ç·¨æˆã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>';
                return;
            }

            savedFormations.forEach(formation => {
                const checkbox = document.createElement('div');
                checkbox.className = 'formation-checkbox';

                const memberNames = formation.members
                    .map(id => {
                        const char = characters.find(c => c.id === id);
                        return char ? (char.period ? `[${char.period}] ${char.name}` : char.name) : 'ä¸æ˜';
                    })
                    .join('ã€');

                const isChecked = selectedFormationsForComparison.includes(formation.id);

                checkbox.innerHTML = `
                    <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleFormationComparison(${formation.id})">
                    <div class="formation-checkbox-label">
                        <div class="formation-checkbox-name">${formation.name}</div>
                        <div class="formation-checkbox-members">ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆ${formation.members.length}ï¼‰: ${memberNames}</div>
                    </div>
                `;

                selector.appendChild(checkbox);
            });
        }

        function toggleFormationComparison(formationId) {
            if (selectedFormationsForComparison.includes(formationId)) {
                selectedFormationsForComparison = selectedFormationsForComparison.filter(id => id !== formationId);
            } else {
                selectedFormationsForComparison.push(formationId);
            }
            renderComparisonChart();
        }

        function renderComparisonChart() {
            const chartDiv = document.getElementById('comparisonChart');
            chartDiv.innerHTML = '';

            if (selectedFormationsForComparison.length === 0) {
                chartDiv.innerHTML = '<p style="color: #999; text-align: center;">ç·¨æˆã‚’é¸æŠã™ã‚‹ã¨ã€æ¯”è¼ƒãƒãƒ£ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>';
                return;
            }

            // å„ç·¨æˆã®ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
            const formationScores = selectedFormationsForComparison.map(formationId => {
                const formation = savedFormations.find(f => f.id === formationId);
                if (!formation) return null;

                const tempFormation = currentFormation;
                currentFormation = formation.members;
                const scores = calculateDetailedBuffScores();
                currentFormation = tempFormation;

                return {
                    name: formation.name,
                    scores: scores
                };
            }).filter(f => f !== null);

            // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®è‰²å®šç¾©
            const categoryColors = {
                'æ°—ç®¡ç†': '#4facfe',
                'é€Ÿåº¦': '#43e97b',
                'è¨ˆç•¥': '#9b59b6',
                'ç§»å‹•é€Ÿåº¦': '#f39c12',
                'å°„ç¨‹': '#e74c3c',
                'æ”»æ’ƒç³»': '#fd79a8',
                'é˜²å¾¡ç³»': '#95a5a6'
            };

            // ç·¨æˆã”ã¨ã®è‰²
            const formationColors = ['#667eea', '#f093fb', '#4facfe', '#43e97b'];

            // å‡¡ä¾‹ã‚’ä½œæˆ
            const legend = document.createElement('div');
            legend.className = 'chart-legend';

            // ã‚«ãƒ†ã‚´ãƒªå‡¡ä¾‹
            Object.entries(categoryColors).forEach(([category, color]) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background: ${color}"></div>
                    <span>${category}</span>
                `;
                legend.appendChild(item);
            });

            // ç·¨æˆå‡¡ä¾‹
            formationScores.forEach((formation, index) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background: ${formationColors[index]}; border: 2px solid ${formationColors[index]}"></div>
                    <span>${formation.name}</span>
                `;
                legend.appendChild(item);
            });

            chartDiv.appendChild(legend);

            // å…¨ã¦ã®ãƒãƒ•ã‚’1ã¤ã®ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªæ¯”è¼ƒãƒãƒ£ãƒ¼ãƒˆã«è¡¨ç¤º
            const categories = Object.keys(formationScores[0].scores);

            // çµ±ä¸€åŸºæº–å€¤ï¼ˆå…¨ã‚«ãƒ†ã‚´ãƒªå…±é€šï¼‰
            const maxBaseValue = 100;

            categories.forEach((category, catIndex) => {
                if (catIndex > 0) {
                    const divider = document.createElement('div');
                    divider.style.height = '2px';
                    divider.style.background = '#e0e0e0';
                    divider.style.margin = '30px 0';
                    chartDiv.appendChild(divider);
                }

                const items = Object.keys(formationScores[0].scores[category]);
                const barsContainer = document.createElement('div');
                barsContainer.className = 'compact-bars';
                barsContainer.style.height = '150px';

                items.forEach((itemName, itemIndex) => {
                    // é …ç›®é–“ã®åŒºåˆ‡ã‚Š
                    if (itemIndex > 0) {
                        const divider = document.createElement('div');
                        divider.className = 'category-divider';
                        barsContainer.appendChild(divider);
                    }

                    // å›ºå®šå€¤ãƒãƒ•ã¯é™¤å¤–
                    const firstBuffData = formationScores[0].scores[category][itemName];
                    if (firstBuffData.isFixed) return;

                    formationScores.forEach((formation, formIndex) => {
                        const buffData = formation.scores[category][itemName];
                        // çµ±ä¸€åŸºæº–å€¤ï¼ˆ100ï¼‰ã«å¯¾ã™ã‚‹å‰²åˆ
                        const height = buffData.numeric > 0 ? Math.min((buffData.numeric / maxBaseValue) * 100, 100) : 0;

                        // ãƒ‡ãƒãƒ•é …ç›®ã¯ä¸é€æ˜åº¦ã‚’ä¸‹ã’ã‚‹
                        let color = formationColors[formIndex];
                        const isDebuff = itemName.includes('ãƒ‡ãƒãƒ•') || itemName.includes('å¢—åŠ ') ||
                                        itemName.includes('ä½ä¸‹') || itemName.includes('å¾Œé€€') || itemName.includes('åœæ­¢');
                        if (isDebuff) {
                            color = formationColors[formIndex] + '80'; // 50%ã®ä¸é€æ˜åº¦
                        }

                        const barItem = document.createElement('div');
                        barItem.className = 'compact-bar-item';
                        barItem.innerHTML = `
                            <div class="compact-bar-container">
                                <div class="compact-bar-fill" style="height: ${height}%; background: ${color}">
                                    <div class="compact-bar-value" style="color: ${color}">${buffData.display}</div>
                                </div>
                            </div>
                            <div class="compact-bar-label">${itemName}</div>
                        `;

                        barsContainer.appendChild(barItem);
                    });
                });

                chartDiv.appendChild(barsContainer);
            });
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;

                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName).classList.add('active');

                // ç·¨æˆã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆãŸã‚‰åˆ©ç”¨å¯èƒ½ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¡¨ç¤º
                if (tabName === 'formation') {
                    renderAvailableCharacters();
                    renderFormation();
                }

                // æ¯”è¼ƒã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆãŸã‚‰ç·¨æˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’è¡¨ç¤º
                if (tabName === 'comparison') {
                    renderFormationSelector();
                    renderComparisonChart();
                }
            });
        });

        // åˆæœŸåŒ–
        loadData();
    </script>
</body>
</html>
